<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    h2 {
      color: #3498db;
      margin-top: 30px;
    }
    pre {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      overflow: auto;
      font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-top: 10px;
    }
    button:hover {
      background-color: #0069d9;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px dashed #ddd;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>WebSocket Connection Test</h1>
  
  <h2>Server Status</h2>
  <div id="server-status" class="status info">Checking server status...</div>
  <pre id="server-status-json">Loading...</pre>
  <button onclick="checkServerStatus()">Refresh Server Status</button>
  
  <h2>WebSocket Health Check</h2>
  <div id="ws-check-status" class="status info">Checking WebSocket health...</div>
  <pre id="ws-check-json">Loading...</pre>
  <button onclick="checkWsHealth()">Refresh WebSocket Health</button>
  
  <h2>WebSocket Connection Test</h2>
  <div id="ws-test-status" class="status warning">Not tested yet</div>
  <button id="ws-test-btn" onclick="testWebSocket()">Test WebSocket Connection</button>
  
  <h2>Connection Log</h2>
  <div id="log-container" style="max-height: 300px; overflow-y: auto;">
    <div id="connection-log"></div>
  </div>
  <button onclick="clearLog()">Clear Log</button>

  <script>
    // --- Utility Functions ---
    function log(message, type = 'info') {
      const logContainer = document.getElementById('connection-log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      
      const timestamp = new Date().toISOString().replace('T', ' ').substr(0, 19);
      entry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span class="${type}">${message}</span>`;
      
      logContainer.appendChild(entry);
      logContainer.parentElement.scrollTop = logContainer.parentElement.scrollHeight;
    }

    function updateStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `status ${type}`;
    }

    // --- Server Status Functions ---
    async function checkServerStatus() {
      try {
        log('Checking server status...');
        updateStatus('server-status', 'Checking server status...', 'info');
        document.getElementById('server-status-json').textContent = 'Loading...';
        
        const response = await fetch('/api/status');
        const data = await response.json();
        
        log(`Server status: ${response.status} ${response.statusText}`, 'success');
        updateStatus('server-status', 'Server is running', 'success');
        document.getElementById('server-status-json').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        log(`Error checking server status: ${error.message}`, 'error');
        updateStatus('server-status', `Error: ${error.message}`, 'error');
        document.getElementById('server-status-json').textContent = 'Failed to fetch server status';
      }
    }

    // --- WebSocket Health Check Functions ---
    async function checkWsHealth() {
      try {
        log('Checking WebSocket health...');
        updateStatus('ws-check-status', 'Checking WebSocket health...', 'info');
        document.getElementById('ws-check-json').textContent = 'Loading...';
        
        const response = await fetch('/api/ws-check');
        const data = await response.json();
        
        log(`WebSocket health check: ${response.status} ${response.statusText}`, 'success');
        updateStatus('ws-check-status', 'WebSocket server is running', 'success');
        document.getElementById('ws-check-json').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        log(`Error checking WebSocket health: ${error.message}`, 'error');
        updateStatus('ws-check-status', `Error: ${error.message}`, 'error');
        document.getElementById('ws-check-json').textContent = 'Failed to fetch WebSocket health';
      }
    }

    // --- WebSocket Test Functions ---
    function testWebSocket() {
      // Disable button during test
      const testButton = document.getElementById('ws-test-btn');
      testButton.disabled = true;
      
      log('Starting WebSocket connection test...');
      updateStatus('ws-test-status', 'Connecting...', 'warning');
      
      try {
        // Create WebSocket URL
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        log(`Attempting to connect to WebSocket at: ${wsUrl}`);
        
        // Create WebSocket connection
        const ws = new WebSocket(wsUrl);
        
        // Set up connection timeout
        const connectionTimeout = setTimeout(() => {
          if (ws.readyState !== WebSocket.OPEN) {
            log('WebSocket connection timeout after 10 seconds', 'error');
            updateStatus('ws-test-status', 'Connection timeout', 'error');
            ws.close();
            testButton.disabled = false;
          }
        }, 10000);
        
        // Connection opened
        ws.addEventListener('open', (event) => {
          clearTimeout(connectionTimeout);
          log('WebSocket connection established successfully', 'success');
          updateStatus('ws-test-status', 'Connected successfully!', 'success');
          
          // Send a ping message
          const pingMessage = JSON.stringify({ type: 'ping', timestamp: Date.now() });
          ws.send(pingMessage);
          log(`Sent message: ${pingMessage}`);
          
          // Close connection after a few seconds
          setTimeout(() => {
            log('Closing WebSocket connection (test complete)');
            ws.close();
            testButton.disabled = false;
          }, 3000);
        });
        
        // Listen for messages
        ws.addEventListener('message', (event) => {
          log(`Received message: ${event.data}`, 'success');
        });
        
        // Listen for errors
        ws.addEventListener('error', (event) => {
          clearTimeout(connectionTimeout);
          log('WebSocket connection error occurred', 'error');
          updateStatus('ws-test-status', 'Connection error', 'error');
          testButton.disabled = false;
        });
        
        // Listen for connection close
        ws.addEventListener('close', (event) => {
          clearTimeout(connectionTimeout);
          log(`WebSocket connection closed. Code: ${event.code}, Reason: ${event.reason}`, 
              event.code === 1000 ? 'info' : 'warning');
          
          if (event.code !== 1000) {
            updateStatus('ws-test-status', `Closed with code ${event.code}`, 'warning');
          }
          
          testButton.disabled = false;
        });
      } catch (error) {
        log(`Error creating WebSocket: ${error.message}`, 'error');
        updateStatus('ws-test-status', `Error: ${error.message}`, 'error');
        testButton.disabled = false;
      }
    }

    function clearLog() {
      document.getElementById('connection-log').innerHTML = '';
      log('Log cleared');
    }

    // Run initial checks when page loads
    window.addEventListener('load', () => {
      log('Page loaded');
      checkServerStatus();
      checkWsHealth();
    });
  </script>
</body>
</html>